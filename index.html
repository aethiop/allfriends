<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style.css" />
    <title>All friends</title>
</head>
<style>
    /*
		Choose white text on a black background so you can add color in.
		Pick your favorite font and choose a font size.
	*/
    @import url('https://fonts.googleapis.com/css2?family=Dosis:wght@200;300;400;500;600;700;800&display=swap');

    html,
    body {
        font-family: "Dosis", sans-serif;
    }
</style>

<body class="black whitet">

    <!-- Welcome Screen -->
    <div class="hold full hue2" id="app">
        <div class="center" id="welcome">
            <h1 class="fat">All<span class="blackt">Friends</span></h1>
            <div class="center" style="width: 50%" id="register-section">
                <input class="crack center inside row" type="text" id="username" placeholder="Enter Username" />
                <button class="white blackt sap row higher " id="register-button" onclick="register()">Register</button>
            </div>
            <div class="crack">
                <div class="center" id="login-section" style="display: none; width:50%">
                    <input class="crack center inside row" type="text" id="key" placeholder="Paste Key" />
                    <button class="white blackt sap row higher" id="login-button"
                        onclick="login(JSON.parse($('#key').val()))">Login</button>
                </div>
            </div>
            <button style="cursor:pointer; display: none" onMouseOver="this.style.color='#ffffff1f'"
                onMouseOut="this.style.color='#ffffff99'" class=" row" id="forgot-navigate">Lost Key?</button>
            <button style="cursor:pointer" class="whitet sit" id="login-navigate">Already have an account?</button>
            <button class="whitet row" id="register-navigate" style="display: none;cursor:pointer">Create an
                account!</button>
        </div>
        <div id="home" style="display: none">
            <div class="page center" style="width: 50%">
                <h1 id="title"></h1>
                <button class="whitet black sap crack" onclick="navigator.clipboard.writeText(profile.key.pub)">Copy
                    Public Address</button>
                <p class="tintt crack thin">Enter public key of your friends (3 to 5 unique friends)</p>
                <div class="crack " style="display: flex; flex-direction: column;">
                    <div class="crack" id="friends"></div>
                    <input class="crack row" placeholder="Enter public key of your friend" type="text" id="pub" />
                    <button class="blackt white sap crack" id="addPub" onclick="addPubs()">Add</button>
                    <button class="hide whitet black sap crack" id="setup3FA" onclick="setup3FA()">Submit</button>
                </div>
                <div class="">
                    <button class="shade whitet sap crack" id="logout-button" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>

        <div id="lost" class="center" style="display: none">
            <h1 class="fat">Lost<span class="blackt">Key?</span></h1>
            <div class="center" style="width: 50%" id="register-section">
                <input class="crack center inside row" type="text" id="lostPub" placeholder="Enter Your public key" />
                <button class="white blackt sap row " id="forgot-button" onclick="forgotPassword()">Share
                    URL</button>
            </div>
        </div>
        <div id="help" class="center" style="display: none">
            <h1 class="fat">Is <span class="blackt" id="lostUsername"></span> the one who sent you the link?</h1>
            <div class="center" style="width: 50%" display:flex; direction: column; justify-content: center; width:
                50%">
                <button id="accept" class="white blackt sap crack row">Yes</button>
                <button id="ignore" class="black whitet sap row">Go Back</button>
            </div>
        </div>
        <div id="waiting" class="center" style="display: none">
            <p id="status" class="fat">Waiting for approval</p>
            <div class="center" style="width: 50%" id="goback-container"></div>
        </div>
    </div>
</body>

<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/then.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/lib/fun.js"></script>
<script src="./secrets.min.js"></script>

<script>

    const gun = Gun({peers:['https://andromedastudio.herokuapp.com/gun']}); 

    const profile = {
        username: "",
        key: {},
        secretPubs: []
    }

    const user = gun.user();


    //Helpers
    const swap = (current, next) => {
        $("#" + current).hide()
        $("#" + next).show()
    }

    const appendUser = (to, name, pub) => {
        var user = `<div id='${pub}' class="bolder blackt"> ${name}</div>`;
        to.append(user)
    }

    //Register account
    const register = () => {
        var name = $("#username").val()
        return SEA.pair().then(async (k) => {
            login(k)
            name && user.get("profile").get("name").put(name)
            user.get("epub").put(user._.sea.epub)
            $("#username").val("")
        })

    }
    // Login using key
    const login = async (key) => {
        user.auth(key);

        localStorage.setItem("userkey", JSON.stringify(key));
        console.log("Key: ", JSON.stringify(key));
        if (user.is) {
            var username = await user.get("profile").get("name").then()
            $("#title").html(`Welcome <span class="blackt">${username}</span>`)
            profile.username = username
            profile.key = key;
            swap("welcome", "home")
        }
        $("#key").val("")
        $("#waiting").hide()
    }

    const addPubs = async () => {
        var pub = $("#pub").val()
        var name = await gun.user(pub).get("profile").get("name").then()
        if (name) {
            if (!(profile.secretPubs.includes(pub)) && pub != profile.pub) {
                appendUser($("#friends"), name, pub)
            }
            else {
                console.log("error")
            }
            profile.secretPubs.length >= 2 && $("#setup3FA").removeClass("hide")
            profile.secretPubs = [...profile.secretPubs, pub]
        }
        $("#pub").val("")


    }


    const forgotPassword = async () => {
        // Get the public key 
        var pub = $("#lostPub").val()
        var name = await gun.user(pub).get('profile').get('name').then()
        console.log(name)

        // Create a throwaway key and encrypt the pub with the key
        var throwaway = await SEA.pair();

        var hash = await SEA.work(throwaway.pub, null, null, { name: "SHA-256", encode: 'hex' });

        var encData = await SEA.encrypt(pub, throwaway)


        gun.get("lost").get(hash).put(encData)

        var url = `${location.href}?p=${throwaway.epriv}#${hash}`
        navigator.clipboard.writeText(url).then(() => {
            $("#forgot-button").html("Copied URL")
        })
        history.pushState({}, '', url)
        location.reload()

        $("#lostPub").val("")

    }

    const logout = () => {
        localStorage.removeItem("userkey")
        user.leave()
        swap("home", "welcome")
    }

    // Encryptes deffie helman encryption with key and epub of the shared instance
    const secretEncrypt = async (data, key, epub) => await SEA.encrypt(data, await SEA.secret(epub, key))
    const secretDecrypt = async (data, key, epub) => await SEA.decrypt(data, await SEA.secret(epub, key))
    const setup3FA = async () => {
        if (profile.secretPubs.length >= 3) {
            const backupKey = SEA.random(128).toString('hex')
            user.get('3fauth').put(await SEA.encrypt(user._.sea, backupKey))
            const pieces = secrets.share(backupKey, 5, 3)
            profile.secretPubs.forEach(async (pub, index) => {
                const epub = await gun.get(`~${pub}`).get("epub").then()
                var encrypted = await secretEncrypt(pieces[index], user._.sea, epub)
                user.get('3fa').get(pub).put(encrypted)
            })
        }
    }
    const helpFriend = async () => {
        if (window.location.search) {
            var pass = new URLSearchParams(window.location.search).get("p");
            var hash = window.location.hash.slice(1)
            var lostPub = await SEA.decrypt(await gun.get('lost').get(hash).then(), pass);
            var lostEpub = await gun.get(`~${lostPub}`).get("epub").then()
            var lostUsername = await gun.user(lostPub).get("profile").get("name").then()
            if (user.is) {
                swap("home", "help")
                var decryptedPiece = await secretDecrypt(await gun.user(lostPub).get('3fa').get(profile.key.pub).then(), profile.key, lostEpub)
                $("#lostUsername").text(lostUsername)
                $("#accept").click(() => {
                    gun.get("approvals").get(hash).set(decryptedPiece)
                })
            }
            else {
                swap("welcome", "waiting")
                var piecesFound = []
                gun.get("approvals").get(hash).map().on(async data => {
                    piecesFound = [...piecesFound, data]
                    if (piecesFound.length == 3) {
                        var backup = secrets.combine(piecesFound)
                        var authKey = await SEA.decrypt(await gun.user(lostPub).get('3fauth').then(), backup)
                        var buttonLogin = `<button class="white blackt sap" id="backIn">Login</button>`
                        $("#status").text("Found your key: " + JSON.stringify(authKey))
                        $("#goback-container").append(buttonLogin)
                        $("#backIn").click(() => {
                            login(authKey)
                            window.location.href = "/";
                        })
                    }
                })


            }
        }

    }

    $("#ignore").click(() => {
        window.location.href = "/"
    })
    const init = async () => {

        // Check local storage for key

        helpFriend()
        let key = localStorage.getItem("userkey")
        key && login(JSON.parse(key))


        // Navigation Logic
        $("#login-navigate").click(() => {
            swap("login-navigate", "register-navigate");
            swap("register-section", "login-section")
            $("#forgot-navigate").show();
        })
        $("#forgot-navigate").click(() => {
            swap("welcome", "lost")
        })
        $("#register-navigate").click(() => {
            swap("register-navigate", "login-navigate");
            swap("login-section", "register-section")
            $("#forgot-navigate").hide();

        })
    }
    init();

</script>

</html>
